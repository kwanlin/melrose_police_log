---
title: "Melrose Police Log"
author: "Kwan Lin"
date: "7/19/2017"
output:
  hrbrthemes::ipsum:
    keep_md: true
editor_options:
  chunk_output_type: inline
---

# Setup

```{r setup, include=FALSE}
#setwd(dir = "~/projects/melrose_police_log/")
#knitr::opts_knit$set(root.dir = "~/pro jects/melrose_police_log/")
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE,
                      echo=FALSE,
                      fig.retina=2,
                      dev=c("png", "cairo_pdf"))
```

```{r packages}
library(tidyverse)
library(rprojroot)
library(rvest)
library(httr)
library(pbapply)
library(stringr)
# library(officer)
library(textreadr)

# themes
library(hrbrthemes)
```

```{r paths}
root_path <- find_rstudio_root_file()
```

# Overview

This is a project to extract and analyze data from Melrose police logs.

# References

https://stackoverflow.com/questions/33790052/download-all-files-from-a-folder-on-a-website



# Data

```{r scrape-melrose-police-logs}
log_url <- "https://melrosepolice.net/police-logs/"

url_contents <- read_html(log_url)

docs <- grep("docx", html_attr(html_nodes(url_contents, "a[href]"), "href"), value=TRUE)


# ignore errors
options(warn = -1)

# apply to a list of urls for .docx files - download each file to a path. includes error handling
lapply(docs, function(x) tryCatch(download.file(x,paste0(root_path,"/data/",basename(x))),
                                  error = function(e) print(paste(basename(x), 'did not work out'))))

# saveRDS(object, file = paste0(root_path,"/data/object.rds"))
```

```{r parse-docx}
test1 <- read_docx("../data/Dispatch-Log-From-April-13-20-2015.docx")

test1

test1_df <- as.data.frame(test1)

test1_df_parse <- test1_df %>%
  filter(grepl("\\d{2}-\\d{4} \\d{4}|Location|Vicinity", test1)) %>%
  mutate(incident_tag = ifelse(grepl("\\d{2}-\\d{4} \\d{4}", test1),1,0)) %>%
  mutate(inc_cnt = cumsum(incident_tag)) %>%
  # mutate(field_type = iflese())
  # select(-c(incident_tag)) %>%
  spread(incident_tag, test1) %>%
  janitor::clean_names() %>%
  #rename("location" = "x0") %>%
  mutate(location = gsub("Location/Address: |Vicinity of: ", "", x0)) %>%
  # mutate(location = )
  mutate(incident_id = stringr::str_extract(x1, "\\d{2}-\\d{4} \\d{4}")) %>%
  mutate(hour_min = stringr::str_extract(x1, " \\d{4}")) %>%
  mutate(accident = ifelse(grepl("ACCIDENT|accident", x1), 1, 0))

#TODO: Add date field
```

# Analysis